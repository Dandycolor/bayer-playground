<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bayer Dithering Playground</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0f0f0f; color: #eee; }
    .container { display: flex; height: 100vh; }
    .preview-area { flex: 1; background: #1a1a1a; position: relative; overflow: hidden; }
    .preview-canvas { width: 100%; height: 100%; display: block; }
    .controls-area { width: 320px; background: #161618; border-left: 1px solid #333; padding: 20px; overflow-y: auto; }
    .control-group { margin-bottom: 20px; }
    .control-label { font-size: 12px; font-weight: 600; text-transform: uppercase; color: #999; margin-bottom: 8px; display: block; }
    .color-input { width: 100%; height: 40px; border: 1px solid #333; border-radius: 4px; cursor: pointer; }
    .slider-input { width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; color: #eee; }
    .slider-value { font-size: 12px; color: #999; margin-top: 4px; }
    .circle-item { background: #1a1a1a; border: 1px solid #333; border-radius: 4px; padding: 12px; margin-bottom: 12px; font-size: 12px; }
    .circle-item-title { font-weight: 600; color: #aaa; margin-bottom: 8px; }
    .circle-input { width: 100%; padding: 6px; background: #0f0f0f; border: 1px solid #333; border-radius: 3px; color: #eee; margin-bottom: 6px; font-size: 11px; }
    .btn-copy { width: 100%; padding: 12px; background: #603ADB; border: none; border-radius: 4px; color: white; font-weight: 600; cursor: pointer; margin-top: 20px; font-size: 13px; }
    .btn-copy:hover { background: #7b4ce8; }
    .output-area { margin-top: 20px; padding: 12px; background: #1a1a1a; border: 1px solid #333; border-radius: 4px; }
    .output-label { font-size: 10px; color: #666; text-transform: uppercase; margin-bottom: 8px; }
    .output-code { max-height: 150px; overflow-y: auto; font-size: 10px; font-family: 'Courier New', monospace; color: #888; line-height: 1.4; word-break: break-all; }
    .btn-group { display: flex; gap: 8px; }
    .btn-group button { flex: 1; padding: 8px; font-size: 12px; border: 1px solid #333; background: #1a1a1a; color: #aaa; border-radius: 3px; cursor: pointer; }
    .btn-group button:hover { background: #252525; color: #ccc; }
  </style>
</head>
<body>
  <div class="container">
    <div class="preview-area">
      <canvas id="preview"></canvas>
    </div>
    <div class="controls-area">
      <div class="control-group">
        <label class="control-label">Background Color</label>
        <input type="color" id="bgColorInput" class="color-input" value="#161518">
      </div>
      <div class="control-group">
        <label class="control-label">Dot Color</label>
        <input type="color" id="dotColorInput" class="color-input" value="#603ADB">
      </div>
      <div class="control-group">
        <label class="control-label">Dot Spacing ({value})</label>
        <input type="range" id="spacingInput" class="slider-input" min="4" max="20" value="8">
        <div class="slider-value" id="spacingValue">8</div>
      </div>
      <div class="control-group">
        <label class="control-label">Dot Radius ({value})</label>
        <input type="range" id="radiusInput" class="slider-input" min="0.1" max="0.5" step="0.05" value="0.35">
        <div class="slider-value" id="radiusValue">0.35</div>
      </div>
      <div class="control-group">
        <label class="control-label">Animation Speed ({value})</label>
        <input type="range" id="speedInput" class="slider-input" min="0.5" max="2" step="0.1" value="1">
        <div class="slider-value" id="speedValue">1</div>
      </div>
      <div class="control-group">
        <label class="control-label">Circles</label>
        <div id="circlesList"></div>
      </div>
      <div class="output-area">
        <div class="output-label">Tilda Code</div>
        <div class="output-code" id="outputCode"></div>
      </div>
      <div class="btn-group">
        <button id="copyBtn" style="flex: 2;">Copy to Clipboard</button>
        <button id="resetBtn" style="flex: 1;">Reset</button>
      </div>
    </div>
  </div>

  <script>    const canvas = document.getElementById('preview');
    const ctx = canvas.getContext('2d');
    
    let config = {
      bgColor: '#161518',
      dotColor: '#603ADB',
      spacing: 8,
      radiusFactor: 0.35,
      speed: 1,
      circles: [
        { x: -0.5, y: -0.3, r: 0.55, phase: 0.0 },
        { x:  0.4, y: -0.25, r: 0.50, phase: 1.5 },
        { x: -0.3, y:  0.35, r: 0.45, phase: 2.3 },
        { x:  0.45, y:  0.40, r: 0.60, phase: 3.7 }
      ]
    };
    
    const bayer = [0, 8, 2, 10, 12, 4, 14, 6, 3, 11, 1, 9, 15, 7, 13, 5];
    
    function resizeCanvas() {
      const rect = canvas.parentElement.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
    }
    
    function smoothstep(e0, e1, x) {
      let t = (x - e0) / (e1 - e0);
      t = Math.max(0, Math.min(1, t));
      return t * t * (3 - 2 * t);
    }
    
    function draw(time) {
      const w = canvas.width;
      const h = canvas.height;
      const minSide = Math.min(w, h);
      const radius = config.spacing * config.radiusFactor;
      const cx = w * 0.5;
      const cy = h * 0.5;
      
      ctx.fillStyle = config.bgColor;
      ctx.fillRect(0, 0, w, h);
      ctx.fillStyle = config.dotColor;
      
      for (let y = 0; y < h; y += config.spacing) {
        for (let x = 0; x < w; x += config.spacing) {
          const nx = (x - cx) / minSide;
          const ny = (y - cy) / minSide;
          
          let mask = 0;
          for (const circle of config.circles) {
            const ox = circle.x + Math.cos(time * 0.2 * config.speed + circle.phase) * 0.05;
            const oy = circle.y + Math.sin(time * 0.25 * config.speed + circle.phase) * 0.05;
            const dx = nx - ox;
            const dy = ny - oy;
            const d = Math.sqrt(dx*dx + dy*dy);
            mask += smoothstep(circle.r, circle.r * 0.65, d);
          }
          
          if (mask <= 0.02) continue;
          if (mask > 1.0) mask = 1.0;
          
          const bx = Math.floor(x / config.spacing) % 4;
          const by = Math.floor(y / config.spacing) % 4;
          const threshold = (bayer[by * 4 + bx] + 0.5) / 16;
          const v = mask * (0.8 + 0.2 * Math.sin(time * 0.8 * config.speed + (x + y) * 0.01));
          
          if (v >= threshold) {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
          }
        }
      }
    }
    
    function animate(time) {
      draw(time * config.speed);
      requestAnimationFrame(animate);
    }
    
    function updateUI() {
      document.getElementById('spacingValue').textContent = config.spacing;
      document.getElementById('radiusValue').textContent = config.radiusFactor.toFixed(2);
      document.getElementById('speedValue').textContent = config.speed.toFixed(1);
      updateCirclesList();
      generateTildaCode();
    }
    
    function updateCirclesList() {
      const list = document.getElementById('circlesList');
      list.innerHTML = '';
      config.circles.forEach((c, i) => {
        const item = document.createElement('div');
        item.className = 'circle-item';
        item.innerHTML = `
          <div class="circle-item-title">Circle ${i + 1}</div>
          X: <input type="number" step="0.1" value="${c.x}" data-circle="${i}" data-prop="x" class="circle-input">
          Y: <input type="number" step="0.1" value="${c.y}" data-circle="${i}" data-prop="y" class="circle-input">
          R: <input type="number" step="0.05" value="${c.r}" data-circle="${i}" data-prop="r" class="circle-input">
          P: <input type="number" step="0.1" value="${c.phase}" data-circle="${i}" data-prop="phase" class="circle-input">
        `;
        list.appendChild(item);
      });
      document.querySelectorAll('.circle-input').forEach(input => {
        input.addEventListener('change', (e) => {
          const idx = parseInt(e.target.dataset.circle);
          const prop = e.target.dataset.prop;
          config.circles[idx][prop] = parseFloat(e.target.value);
          generateTildaCode();
        });
      });
    }
    
    function generateTildaCode() {
      const bgHex = config.bgColor;
      const dotHex = config.dotColor;
      const spaceVal = config.spacing;
      const radiusVal = config.radiusFactor;
      const speedVal = config.speed;
      const circlesJSON = JSON.stringify(config.circles);
      
      const tildaCode = `<div id="bayer-bg"></div>

<style>
  #bayer-bg {
    position: relative;
    width: 100%;
    height: 100vh;
    background-color: ${bgHex};
    overflow: hidden;
  }
  #bayer-bg canvas {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
  }
</style>

<script>
(function() {
  var container = document.getElementById('bayer-bg');
  if (!container) return;

  var canvas = document.createElement('canvas');
  var ctx = canvas.getContext('2d');
  container.appendChild(canvas);

  function resize() {
    canvas.width  = container.clientWidth;
    canvas.height = container.clientHeight;
  }
  resize();
  window.addEventListener('resize', resize);

  var bayer = [0, 8, 2, 10, 12, 4, 14, 6, 3, 11, 1, 9, 15, 7, 13, 5];
  var bgColor = '${bgHex}';
  var dotColor = '${dotHex}';
  var spacing = ${spaceVal};
  var radiusFactor = ${radiusVal};
  var speed = ${speedVal};
  var circles = ${circlesJSON};

  function smoothstep(e0, e1, x) {
    var t = (x - e0) / (e1 - e0);
    if (t < 0) t = 0;
    if (t > 1) t = 1;
    return t * t * (3 - 2 * t);
  }

  function draw(time) {
    time *= 0.001;
    var w = canvas.width;
    var h = canvas.height;
    var minSide = Math.min(w, h);
    var radius = spacing * radiusFactor;
    var cx = w * 0.5;
    var cy = h * 0.5;

    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, w, h);
    ctx.fillStyle = dotColor;

    for (var y = 0; y < h; y += spacing) {
      for (var x = 0; x < w; x += spacing) {
        var nx = (x - cx) / minSide;
        var ny = (y - cy) / minSide;

        var mask = 0;
        for (var i = 0; i < circles.length; i++) {
          var c = circles[i];
          var ox = c.x + Math.cos(time * 0.2 * speed + c.phase) * 0.05;
          var oy = c.y + Math.sin(time * 0.25 * speed + c.phase) * 0.05;
          var dx = nx - ox;
          var dy = ny - oy;
          var d = Math.sqrt(dx*dx + dy*dy);
          mask += smoothstep(c.r, c.r * 0.65, d);
        }

        if (mask <= 0.02) continue;
        if (mask > 1.0) mask = 1.0;

        var bx = Math.floor(x / spacing) % 4;
        var by = Math.floor(y / spacing) % 4;
        var threshold = (bayer[by * 4 + bx] + 0.5) / 16;
        var v = mask * (0.8 + 0.2 * Math.sin(time * 0.8 * speed + (x + y) * 0.01));

        if (v >= threshold) {
          ctx.beginPath();
          ctx.arc(x, y, radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }
    requestAnimationFrame(draw);
  }

  requestAnimationFrame(draw);
})();
</script>`;
      
      document.getElementById('outputCode').textContent = tildaCode.substring(0, 300) + '...';
      document.getElementById('copyBtn').dataset.code = tildaCode;
    }
    
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);
    
    document.getElementById('bgColorInput').addEventListener('change', (e) => {
      config.bgColor = e.target.value;
      generateTildaCode();
    });
    
    document.getElementById('dotColorInput').addEventListener('change', (e) => {
      config.dotColor = e.target.value;
      generateTildaCode();
    });
    
    document.getElementById('spacingInput').addEventListener('input', (e) => {
      config.spacing = parseInt(e.target.value);
      updateUI();
    });
    
    document.getElementById('radiusInput').addEventListener('input', (e) => {
      config.radiusFactor = parseFloat(e.target.value);
      updateUI();
    });
    
    document.getElementById('speedInput').addEventListener('input', (e) => {
      config.speed = parseFloat(e.target.value);
      updateUI();
    });
    
    document.getElementById('copyBtn').addEventListener('click', () => {
      const code = document.getElementById('copyBtn').dataset.code;
      navigator.clipboard.writeText(code).then(() => {
        alert('Code copied to clipboard!');
      });
    });
    
    document.getElementById('resetBtn').addEventListener('click', () => {
      config = {
        bgColor: '#161518',
        dotColor: '#603ADB',
        spacing: 8,
        radiusFactor: 0.35,
        speed: 1,
        circles: [
          { x: -0.5, y: -0.3, r: 0.55, phase: 0.0 },
          { x:  0.4, y: -0.25, r: 0.50, phase: 1.5 },
          { x: -0.3, y:  0.35, r: 0.45, phase: 2.3 },
          { x:  0.45, y:  0.40, r: 0.60, phase: 3.7 }
        ]
      };
      document.getElementById('bgColorInput').value = '#161518';
      document.getElementById('dotColorInput').value = '#603ADB';
      document.getElementById('spacingInput').value = 8;
      document.getElementById('radiusInput').value = 0.35;
      document.getElementById('speedInput').value = 1;
      updateUI();
    });
    
    updateUI();
    animate(0);
  </script>
</body>
</html>
